!function(t){"use strict";function e(){for(var t={},n=0;n<arguments.length;n++){var o=arguments[n];if("object"==typeof o)for(var r in o)o[r]&&t[r]&&"object"==typeof o[r]&&"object"==typeof t[r]&&"db"!==r?t[r]=e(t[r]||{},o[r]):t[r]=o[r]}return t}var n;n="object"==typeof exports?exports:t.BackbonePouch={};var o=t._;o||"function"!=typeof require||(o=require("underscore"));var r={create:"post",update:"put",patch:"put","delete":"remove"};n.defaults={fetch:"allDocs",listen:!1,options:{post:{},put:{},get:{},remove:{},allDocs:{},query:{},spatial:{},changes:{continuous:!0}}},n.sync=function(t){t=t||{},t=e(n.defaults,t);var c=function(n,c,i){function u(t,e){return t?i.error&&i.error(t):("create"!==n&&"update"!==n&&"patch"!==n||(e={_id:e.id,_rev:e.rev}),"delete"===n&&(e={}),"read"===n&&i.listen&&o.result(i,"db").info(function(t,e){o.result(i,"db").changes(o.extend({},i.options.changes,{since:e.update_seq,onChange:function(t){var e=c.get(t.id);t.deleted?e&&e.destroy():e?e.set(t.doc):c.add(t.doc),"function"==typeof i.options.changes.onChange&&i.options.changes.onChange(t)}}))}),i.success&&i.success(e))}if(i=i||{},i=e(t,c&&c.pouch||{},i),"string"!=typeof n)return i;if(!i.db)throw new Error('A "db" property must be specified');if(c.trigger("request",c,o.result(i,"db"),i),"read"===n){if(c.id)return o.result(i,"db").get(c.id,i.options.get,u);if("query"===i.fetch||"spatial"===i.fetch){if(!i.options[i.fetch].fun)throw new Error('A "'+i.fetch+'.fun" object must be specified');return o.result(i,"db")[i.fetch](i.options[i.fetch].fun,i.options[i.fetch]).then(function(t){u(null,t)})["catch"](function(t){u(t)})}o.result(i,"db")[i.fetch](i.options[i.fetch],u)}else o.result(i,"db")[r[n]](c.toJSON(),i.options[r[n]],u);return i};return c.defaults=t,c},n.attachments=function(t){function e(e){if(e.pouch&&e.pouch.db)return o.result(e.pouch,"db");if(e.collection&&e.collection.pouch&&e.collection.pouch.db)return o.result(e.collection.pouch,"db");if(t.db)return o.result(t,"db");var n=e.sync();if(n.db)return o.result(n,"db");throw new Error('A "db" property must be specified')}return t=t||{},{attachments:function(t){var e=this.get("_attachments")||{};return t?o.filter(o.keys(e),function(n){return"function"==typeof t?t(n,e[n]):e[n].content_type.match(t)}):o.keys(e)},attachment:function(t,n){var o=e(this);return o.getAttachment(this.id,t,n)},attach:function(t,n,o,r){"function"==typeof n&&(r=n,n=void 0,o=void 0),"function"==typeof o&&(r=o,o=void 0),n=n||t.filename,o=o||t.type;var c=e(this),i=this;return c.putAttachment(this.id,n,this.get("_rev"),t,o,function(t,e){if(!t&&e.rev){var c=i.get("_attachments")||{};c[n]={content_type:o,stub:!0},i.set({_id:e.id,_rev:e.rev,_attachments:c},{silent:!0})}r(t,e)})}}}}(this);